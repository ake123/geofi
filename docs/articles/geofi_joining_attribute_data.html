<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Joining attribute data with geofi data â€¢ geofi</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Joining attribute data with geofi data">
<meta property="og:description" content="geofi">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geofi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/geofi_datasets.html">Datasets in geofi-package</a>
    </li>
    <li>
      <a href="../articles/geofi_joining_attribute_data.html">Joining attribute data with geofi data</a>
    </li>
    <li>
      <a href="../articles/geofi_making_maps.html">Making maps using geofi-package</a>
    </li>
    <li>
      <a href="../articles/geofi_spatial_analysis.html">Spatial data manipulation and analysis R and geofi-package</a>
    </li>
    <li>
      <a href="../articles/tricolore_tutorial.html">Creating ternary color coded maps</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://ropengov.org">
    <span class="fas fa-users"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/rOpenGov/geofi">
    <span class="fas fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="geofi_joining_attribute_data_files/header-attrs-2.6.6/header-attrs.js"></script><script src="geofi_joining_attribute_data_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Joining attribute data with geofi data</h1>
                        <h4 class="author">Markus Kainu</h4>
            
            <h4 class="date">2021-02-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropengov/geofi/blob/master/vignettes/geofi_joining_attribute_data.Rmd"><code>vignettes/geofi_joining_attribute_data.Rmd</code></a></small>
      <div class="hidden name"><code>geofi_joining_attribute_data.Rmd</code></div>

    </div>

    
    
<p>This vignettes provides few examples on how to join attribute data from common sources of attribute data. Here we are using data from three different sources of which two are from <a href="https://pxnet2.stat.fi/PXWeb/pxweb/en/">Statistics Finland PxWeb-api</a>, namely <a href="https://pxnet2.stat.fi/PXWeb/pxweb/en/Kuntien_avainluvut/">municipality key figures</a> and <a href="https://pxnet2.stat.fi/PXWeb/pxweb/en/Postinumeroalueittainen_avoin_tieto/">Paavo (Open data by postal code area)</a>. Third is <a href="https://thl.fi/fi/tilastot-ja-data/aineistot-ja-palvelut/avoin-data/varmistetut-koronatapaukset-suomessa-covid-19-">Covid-19 tests and confirmed cases in Finland</a>.</p>
<p><strong>Installation</strong></p>
<p><code>geofi</code> is not yet in CRAN, but can be installed from Github using</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"ropengov/geofi"</span><span class="op">)</span></code></pre></div>
<div id="municipalities" class="section level2">
<h2 class="hasAnchor">
<a href="#municipalities" class="anchor"></a>Municipalities</h2>
<p>Municipality data provided by <code><a href="../reference/get_municipalities.html">get_municipalities()</a></code>-function contains 77 indicators variables from each of 309 municipalities. Variables can be used either for aggregating data or as keys for joining attribute data.</p>
<div id="pxweb-data" class="section level3">
<h3 class="hasAnchor">
<a href="#pxweb-data" class="anchor"></a>PxWeb-data</h3>
<p>In this first example we join municipality level data from Statistics Finland <a href="https://pxnet2.stat.fi/PXWeb/pxweb/en/Kuntien_avainluvut/">municipality key figures</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropengov/geofi">geofi</a></span><span class="op">)</span>
<span class="va">muni</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_municipalities.html">get_municipalities</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rOpenGov/pxweb/">pxweb</a></span><span class="op">)</span>
<span class="va">pxweb_query_list</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Alue 2020"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"*"</span><span class="op">)</span>,
       <span class="st">"Tiedot"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"*"</span><span class="op">)</span>,
       <span class="st">"Vuosi"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2019"</span><span class="op">)</span><span class="op">)</span>

<span class="va">px_raw</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/pxweb/man/pxweb_get.html">pxweb_get</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"http://pxnet2.stat.fi/PXWeb/api/v1/en/Kuntien_avainluvut/2020/kuntien_avainluvut_2020_aikasarja.px"</span>,
            query <span class="op">=</span> <span class="va">pxweb_query_list</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sfirke/janitor">janitor</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="va">px_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">px_raw</span>, 
                column.name.type <span class="op">=</span> <span class="st">"text"</span>, 
                variable.value.type <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/make_clean_names.html">make_clean_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">px_data</span>
<span class="co">#&gt; # A tibble: 12,800 x 4</span>
<span class="co">#&gt;    region_2020   information                           year  municipal_key_figuâ€¦</span>
<span class="co">#&gt;    &lt;chr&gt;         &lt;chr&gt;                                 &lt;chr&gt;               &lt;dbl&gt;</span>
<span class="co">#&gt;  1 WHOLE COUNTRY Degree of urbanisation, %             2019                 86.4</span>
<span class="co">#&gt;  2 WHOLE COUNTRY Population                            2019            5525292  </span>
<span class="co">#&gt;  3 WHOLE COUNTRY Population change from the previous â€¦ 2019                  0.1</span>
<span class="co">#&gt;  4 WHOLE COUNTRY Share of persons aged under 15 of thâ€¦ 2019                 15.8</span>
<span class="co">#&gt;  5 WHOLE COUNTRY Share of persons aged 15 to 64 of thâ€¦ 2019                 62  </span>
<span class="co">#&gt;  6 WHOLE COUNTRY Share of persons aged over 64 of theâ€¦ 2019                 22.3</span>
<span class="co">#&gt;  7 WHOLE COUNTRY Share of Swedish-speakers of the popâ€¦ 2019                  5.2</span>
<span class="co">#&gt;  8 WHOLE COUNTRY Share of foreign citizens of the popâ€¦ 2019                  4.8</span>
<span class="co">#&gt;  9 WHOLE COUNTRY Excess of births, persons             2019              -8336  </span>
<span class="co">#&gt; 10 WHOLE COUNTRY Intermunicipal migration gain/loss, â€¦ 2019                  0  </span>
<span class="co">#&gt; # â€¦ with 12,790 more rows</span></code></pre></div>
<p>Once we have the data in long format we can observe the <code>region_2020</code>-column.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">px_data</span>, <span class="va">region_2020</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 400 x 2</span>
<span class="co">#&gt;    region_2020                            n</span>
<span class="co">#&gt;  * &lt;chr&gt;                              &lt;int&gt;</span>
<span class="co">#&gt;  1 Ã„Ã¤nekoski                             32</span>
<span class="co">#&gt;  2 Ã„Ã¤nekoski sub-regional unit           32</span>
<span class="co">#&gt;  3 Ã…boland-Turunmaa sub-regional unit    32</span>
<span class="co">#&gt;  4 Ã„htÃ¤ri                                32</span>
<span class="co">#&gt;  5 Akaa                                  32</span>
<span class="co">#&gt;  6 AlajÃ¤rvi                              32</span>
<span class="co">#&gt;  7 Ã…land                                 32</span>
<span class="co">#&gt;  8 Ã…lands landsbygd sub-regional unit    32</span>
<span class="co">#&gt;  9 Ã…lands skÃ¤rgÃ¥rd sub-regional unit     32</span>
<span class="co">#&gt; 10 Alavieska                             32</span>
<span class="co">#&gt; # â€¦ with 390 more rows</span></code></pre></div>
<p>This is not obvious to all, but have the municipality names in Finnish among other regional breakdowns which allows us to combine the data with spatial data using <code>municipality_name_fi</code>-variable.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">map_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">muni</span>, <span class="va">px_data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"municipality_name_fi"</span> <span class="op">=</span> <span class="st">"region_2020"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now we can plot a map showing <code>Share of Swedish-speakers of the population, %</code> and <code>Share of foreign citizens of the population, %</code> on two panels sharing a scale.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">map_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">'Share of Swedish-speakers of the population|Share of foreign citizens of the population'</span>, <span class="va">information</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">municipal_key_figures</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">information</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></code></pre></div>
<p><img src="geofi_joining_attribute_data_files/figure-html/unnamed-chunk-3-1.png" width="750"></p>
</div>
</div>
<div id="health-districts" class="section level2">
<h2 class="hasAnchor">
<a href="#health-districts" class="anchor"></a>Health Districts</h2>
<p>in early 2021 we are still troubled by the COVID-19 and the health authorities are counting infections, deaths and vaccinated. Lets pull the daily data from API and compare the names of the health districts both in COVID-19 data and in municipality division from Statistics Finland.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org">readr</a></span><span class="op">)</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>
  Area <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,
  Time <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_datetime.html">col_date</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,
  val <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_double</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span> <span class="op">-&gt;</span> <span class="va">cov_cols</span>

<span class="va">thl_korona_api</span> <span class="op">&lt;-</span> <span class="st">"https://sampo.thl.fi/pivot/prod/en/epirapo/covid19case/fact_epirapo_covid19case.csv?row=dateweek20200101-508804L&amp;column=hcdmunicipality2020-445222L"</span>
<span class="va">status</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">thl_korona_api</span><span class="op">)</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span>
  <span class="va">xdf_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv2</a></span><span class="op">(</span><span class="va">thl_korona_api</span>, col_types <span class="op">=</span> <span class="va">cov_cols</span><span class="op">)</span>
  <span class="va">xdf</span> <span class="op">&lt;-</span> <span class="va">xdf_raw</span> <span class="op">%&gt;%</span> 
    <span class="co"># filter(!grepl("Kaikki", Alue)) %&gt;% </span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">Time</span>, 
           shp <span class="op">=</span> <span class="va">Area</span>, 
           day_cases <span class="op">=</span> <span class="va">val</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">shp</span>,<span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">day_cases</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">day_cases</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
  
  <span class="va">xdf</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span>
  
  <span class="va">muni</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_municipalities.html">get_municipalities</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span> 
  <span class="va">muni</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">sairaanhoitop_name_en</span><span class="op">)</span>
<span class="op">}</span> 
<span class="co">#&gt;                     sairaanhoitop_name_en  n</span>
<span class="co">#&gt; 1                                   Ã…land 16</span>
<span class="co">#&gt; 2       Central Finland Hospital District 21</span>
<span class="co">#&gt; 3  Central Ostrobothnia Hospital District 10</span>
<span class="co">#&gt; 4  Helsinki and Uusimaa Hospital District 24</span>
<span class="co">#&gt; 5              ItÃ¤-Savo Hospital District  4</span>
<span class="co">#&gt; 6                Kainuu Hospital District  8</span>
<span class="co">#&gt; 7            Kanta-HÃ¤me Hospital District 11</span>
<span class="co">#&gt; 8           Kymenlaakso Hospital District  6</span>
<span class="co">#&gt; 9           LÃ¤nsi-Pohja Hospital District  6</span>
<span class="co">#&gt; 10                Lappi Hospital District 15</span>
<span class="co">#&gt; 11        North Karelia Hospital District 13</span>
<span class="co">#&gt; 12   North Ostrobothnia Hospital District 29</span>
<span class="co">#&gt; 13           North Savo Hospital District 18</span>
<span class="co">#&gt; 14          PÃ¤ijÃ¤t-HÃ¤me Hospital District 12</span>
<span class="co">#&gt; 15            Pirkanmaa Hospital District 23</span>
<span class="co">#&gt; 16            Satakunta Hospital District 16</span>
<span class="co">#&gt; 17        South Karelia Hospital District  9</span>
<span class="co">#&gt; 18   South Ostrobothnia Hospital District 18</span>
<span class="co">#&gt; 19           South Savo Hospital District  9</span>
<span class="co">#&gt; 20    Southwest Finland Hospital District 28</span>
<span class="co">#&gt; 21                Vaasa Hospital District 13</span></code></pre></div>
<p>The names look identical so we can join the two datasets and plot a map.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">200</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">muni</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">sairaanhoitop_name_en</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">xdf</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sairaanhoitop_name_en"</span> <span class="op">=</span> <span class="st">"shp"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">total_cases</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">sairaanhoitop_name_en</span>, <span class="st">"\n"</span>, <span class="va">total_cases</span><span class="op">)</span><span class="op">)</span>, 
                 color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Number of total COVID-19 cases reported since January 2020"</span>, 
         fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p><img src="geofi_joining_attribute_data_files/figure-html/unnamed-chunk-5-1.png" width="525"></p>
</div>
<div id="zipcode-level" class="section level2">
<h2 class="hasAnchor">
<a href="#zipcode-level" class="anchor"></a>Zipcode level</h2>
<p>You can download data from <a href="https://pxnet2.stat.fi/PXWeb/pxweb/en/Postinumeroalueittainen_avoin_tieto/">Paavo (Open data by postal code area)</a> using <code>pxweb</code>-package in a similar manner as in the first example.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rOpenGov/pxweb/">pxweb</a></span><span class="op">)</span>
<span class="co"># lets get all zipcodes and all variables</span>
<span class="va">pxweb_query_list</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Postinumeroalue"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"*"</span><span class="op">)</span>,
                           <span class="st">"Tiedot"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"*"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Download data </span>
<span class="va">px_raw</span> <span class="op">&lt;-</span> 
 <span class="fu"><a href="https://rdrr.io/pkg/pxweb/man/pxweb_get.html">pxweb_get</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"http://pxnet2.stat.fi/PXWeb/api/v1/en/Postinumeroalueittainen_avoin_tieto/2019/paavo_1_he_2019.px"</span>,
           query <span class="op">=</span> <span class="va">pxweb_query_list</span><span class="op">)</span>

<span class="va">px_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">px_raw</span>, 
                column.name.type <span class="op">=</span> <span class="st">"text"</span>, 
                variable.value.type <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/make_clean_names.html">make_clean_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">px_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">postal_code_area</span> <span class="op">!=</span> <span class="st">"Finland"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 72,624 x 3</span>
<span class="co">#&gt;    postal_code_area               data                paavo_open_data_by_postalâ€¦</span>
<span class="co">#&gt;    &lt;chr&gt;                          &lt;chr&gt;                                    &lt;dbl&gt;</span>
<span class="co">#&gt;  1 00100 Helsinki Keskusta - Etuâ€¦ Inhabitants, totalâ€¦                      18284</span>
<span class="co">#&gt;  2 00100 Helsinki Keskusta - Etuâ€¦ Females, 2017 (HE)                        9613</span>
<span class="co">#&gt;  3 00100 Helsinki Keskusta - Etuâ€¦ Males, 2017 (HE)                          8671</span>
<span class="co">#&gt;  4 00100 Helsinki Keskusta - Etuâ€¦ Average age of inhâ€¦                         41</span>
<span class="co">#&gt;  5 00100 Helsinki Keskusta - Etuâ€¦ 0-2 years, 2017 (Hâ€¦                        434</span>
<span class="co">#&gt;  6 00100 Helsinki Keskusta - Etuâ€¦ 3-6 years, 2017 (Hâ€¦                        521</span>
<span class="co">#&gt;  7 00100 Helsinki Keskusta - Etuâ€¦ 7-12 years, 2017 (â€¦                        711</span>
<span class="co">#&gt;  8 00100 Helsinki Keskusta - Etuâ€¦ 13-15 years, 2017 â€¦                        274</span>
<span class="co">#&gt;  9 00100 Helsinki Keskusta - Etuâ€¦ 16-17 years, 2017 â€¦                        185</span>
<span class="co">#&gt; 10 00100 Helsinki Keskusta - Etuâ€¦ 18-19 years, 2017 â€¦                        264</span>
<span class="co">#&gt; # â€¦ with 72,614 more rows</span></code></pre></div>
<p>Before we can join the data, we must extract the numerical postal code from <code>postal_code_area</code>-variable.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">px_data</span><span class="op">$</span><span class="va">posti_alue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">" .+$"</span>, <span class="st">""</span>, <span class="va">px_data</span><span class="op">$</span><span class="va">postal_code_area</span><span class="op">)</span>

<span class="co"># Lets join with spatial data and plot the area of each zipcode</span>
<span class="va">zipcodes19</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_zipcodes.html">get_zipcodes</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span> 
<span class="va">zipcodes_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">zipcodes19</span>, 
                          <span class="va">px_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">data</span> <span class="op">==</span> <span class="st">"Average age of inhabitants, 2017 (HE)"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">zipcodes_map</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">paavo_open_data_by_postal_code_area_2019</span><span class="op">)</span>, 
          color  <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org//reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Average age of inhabitants, 2017 (HE)"</span>, 
       fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<p><img src="geofi_joining_attribute_data_files/figure-html/unnamed-chunk-6-1.png" width="525"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Markus Kainu, Joona Lehtomaki, Leo Lahti.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
