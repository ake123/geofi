---
title: "Making maps using geofi-package"
author: "Markus Kainu, Leo Lahti & Joona LehtomÃ¤ki"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  # %\VignetteIndexEntry{Making maps using geofi-package}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE,
  fig.height = 10, 
  fig.width = 7
)
```


**Installation**

`geofi` is not yet in CRAN, but can be installed from Github using

```{r, eval = FALSE}
remotes::install_github("ropengov/geofi")
```

This vignettes gives an overview of different options for creating maps in R using the data from `geofi`-package. Vignette is divided in three sections: *packages for static maps*, *static maps using ggplot2* and *interactive maps*. But we begin with the datasets we want to plot.

If you want more detailed explanation of how to plot `sf`-objects take a look at vignette [5. Plotting Simple Features](https://r-spatial.github.io/sf/articles/sf5.html).

## Datasets

Lets start with latest municipality division from `get_municipalities()` with is a *POLYGON* data and with *POINT* data of `municipality_central_localities` that is shipped with the package.

```{r municipality_map}
library(geofi)
polygon <- get_municipalities(year = 2021, scale = 4500)
point <- geofi::municipality_central_localities
# municipality code into integer
point$municipality_code <- as.integer(point$kuntatunnus)
library(sf) # for spatial data operations later
```

They both come in same CRS `r sf::st_crs(point)$input` and can be plotted together without any further manipulation.

## Static maps

There are two main technologies for creating static graphics in R: base and [ggplot2](https://ggplot2.tidyverse.org/). Both can be used to plot spatial data ie. to create maps. In addition, [tmap : thematic maps in R](https://mtennekes.github.io/tmap/) is a great tool if you want to dig deeper into cartography in R.


**base**

```{r}
# dev.off()
plot(st_geometry(polygon["municipality_code"]))
plot(polygon["municipality_code"], add = TRUE, border="white")
plot(st_geometry(point["municipality_code"]), add = TRUE, color = "black")
```

**ggplot2**

```{r}
library(ggplot2)
ggplot() + 
  geom_sf(data = polygon, aes(fill = municipality_code)) +
  geom_sf(data = point)
```

**tmap**


```{r}
library(tmap)
tm_shape(polygon) +
  tm_polygons("municipality_code") +
  tm_shape(point) +
    tm_symbols(col = "black", scale = .5) 
```

As I am only fluent in using `ggplot2` the the more complex examples are using `ggplot2`-package.

## Static maps using ggplot2

`ggplot2`-packages has three `sf`-class spesific functions: `geom_sf` plotting for points, lines and polygons, and `geom_sf_text` and `geom_sf_label` for labeling the maps. In the following examples we are using the Uusimaa region in Southern Finland.

```{r uusimaa, fig.width=10, fig.height=5}
library(dplyr)
polygon_uusimaa <- polygon %>% filter(maakunta_name_fi %in% "Uusimaa")
point_uusimaa <- point %>% filter(municipality_code %in% polygon_uusimaa$municipality_code)
ggplot() + 
  geom_sf(data = polygon_uusimaa) + 
  geom_sf(data = point_uusimaa) + 
  geom_sf_text(data = point_uusimaa, aes(label = teksti))
```

### Label overlapping

`geom_sf_label` or `geom_sf_text` cannot control the overlapping of labels which is a common issue when mapping objects of various shapes and sizes. You can [`ggrepel`](https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html) you can solve the problem though it requires a bit of spatial data handling with `sf`-package.

```{r uusimaa_repel, fig.width=10, fig.height=5}
ggplot() + 
  geom_sf(data = polygon_uusimaa) + 
  geom_sf(data = point_uusimaa) + 
  ggrepel::geom_text_repel(data = point_uusimaa %>%
                        sf::st_set_geometry(NULL) %>%
                        bind_cols(point_uusimaa %>% 
                                    sf::st_centroid() %>% 
                                    sf::st_coordinates() %>% as_tibble()),
                     aes(label = teksti, x = X, y = Y))
```

### Faceting 

```{r}
ggplot() + 
  geom_sf(data = polygon_uusimaa)


```


### Subsetting



### Combining maps



## Interactive maps











Helsinki at 1km by 1km as interactive leaflet map


```{r, population_grid_data2}
library(leaflet)
pop_grid <- get_population_grid(year = 2018, resolution = 1)

pop_grid_helsinki <- sf::st_transform(x = pop_grid %>% 
                                        filter(kunta == "091"), crs = "+proj=longlat +datum=WGS84")



leaflet(pop_grid_helsinki) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~colorQuantile("RdYlGn", vaesto)(vaesto),
              color = "coral", 
              weight = 1,
              smoothFactor = 0.5,
              opacity = 1.0,
              fillOpacity = 0.5,
    label = ~vaesto,
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE))
```



```{r geofacet2, fig.height = 6, fig.width = 7, eval = FALSE}

dat <- left_join(geofi::municipality_key_2019 %>% 
                   filter(maakunta_name_fi == "Ahvenanmaa") %>% 
                   select(-year),
                 px_data) %>% 
  group_by(maakunta_code, maakunta_name_fi,year) %>% 
  rename(code = kunta, name = kunta_name, population = value)

library(geofacet)
library(ggplot2)

ggplot(dat, aes(x = year, y = population/1000, group = name)) + 
  geom_line() + 
  facet_geo(facets = ~name, grid = grid_ahvenanmaa_2019, scales = "free_y") +
  theme(axis.text.x = element_text(size = 6)) +
  scale_x_discrete(breaks = seq.int(from = 1987, to = 2018, by = 5)) +
  labs(title = "Population 1987-2018", y = "population (1000)")
```
